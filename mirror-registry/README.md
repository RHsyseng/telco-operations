# **A first look at mirror registry**

This document provides information on how to use the new mirror-registry designed to provide a lightweight quay for disconnected use case

## **Environment**

* Any box where podman can run. We used centos8stream

## **How To use**

1. Gather the binary at [https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/1.0/mirror-registry.tar.gz](https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/1.0/mirror-registry.tar.gz) and uncompress it

```
curl -s -L https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients/mirror-registry/1.0/mirror-registry.tar.gz | tar xvz -C /usr/bin
```

2. Use it in a simple way

```
/usr/bin/mirror-registry install
```

This will use an autogenerated cert stored in /etc/quay-install and create a random password for the init user. You will have to use podman with insecure mode or trust said certificate in order to interact with the resulting registry

3. You can also be more specific

- REGISTRY_NAME is the fqdn of your box
- SSL_CERT is the path of a valid CA (as generated by openssl)
- SSL_KEY is the path of the corresponding ssl key

```
SSH_KEY="/root/.ssh/id_rsa"
/usr/bin/mirror-registry install --quayHostname ${REGISTRY_NAME} --sslCert ${SSL_CERT} --sslKey ${SSL_KEY} --initPassword ${REGISTRY_PASSWORD} --ssh-key ${SSH_KEY}
```

4. Profit. One can validate the installation with the following command:

```
podman login -u init -p ${REGISTRY_PASSWORD} ${REGISTRY_NAME}:8443
```

## **Development**

In order to modify the registry, you will need:

- git
- make
- podman
- valid credentials for registry.redhat.io

The repository for the code of the registry is stored at [https://github.com/quay/mirror-registry](https://github.com/quay/mirror-registry) , one can create its own modified image by

- authenticating to registry.redhat.io from a valid pull secret

```
PULL_SECRET="/root/openshift_pull.json"
REDHAT_CREDS=$(cat $OPENSHIFT_PULL_JSON | jq .auths.\"registry.redhat.io\".auth -r | base64 -d)
RHN_USER=$(echo $REDHAT_CREDS | cut -d: -f1)
RHN_PASSWORD=$(echo $REDHAT_CREDS | cut -d: -f2)
podman login -u "$RHN_USER" -p "$RHN_PASSWORD" registry.redhat.io
```

- creating a tar with all the contents( the dependency images get bundled)

```
make build-online-zip
```

## **Limitations/Additional Notes**

- the command can also target a remote host, although we didnt see too much benefit to going with such approach.
- It was not possible to specify a different user than init in the first release. We opened [https://github.com/quay/mirror-registry/pull/46](https://github.com/quay/mirror-registry/pull/46) to address it, which got merged so this will be possible in an upcoming release.
- IPV6 isn't currently supported by quay. We opened [https://github.com/quay/mirror-registry/pull/47](https://github.com/quay/mirror-registry/pull/47) to address it by using a side haproxy container, but this got closed. For the time beeing, the folder [ipv6](ipv6) contains assets allowing to deploy an extra container in an ipv6 context. This can be deployed with the following instructions:

```
cp quay_haproxy.cfg /etc/quay-install/haproxy.cfg
cp quay_haproxy.service /usr/lib/systemd/system
systemctl daemon-reload
systemctl enable --now quay-haproxy
```

## **Mirroring content with `oc-mirror`**

One of the main use cases of a mirror registry is enabling OpenShift disconnected installs. There is a new tool that will be released soon that will simplify the way we do OCP mirrors.

:warning: The information below makes use of unreleased software, and as such, it's not supported. What works today may or may not work tomorrow.

### **Building the tool**

As we mentioned, the tool is still not released and as such we need to build it ourselves.

1. Clone the git repo

    ~~~sh
    git clone https://github.com/openshift/oc-mirror.git
    cd oc-mirror/
    ~~~

2. Run the build script and copy the resulting binary to a location withing the PATH

    ~~~sh
    ./hack/build.sh
    sudo cp ./bin/oc-mirror /usr/local/bin/
    ~~~

### **Configuring the mirror config file**

The tool uses a `yaml` configuration file where you describe what you want to mirror, you have several examples in [the repository](https://github.com/openshift/oc-mirror/tree/main/docs/examples).

Our configuration file looks as follows:

~~~yaml
apiVersion: mirror.openshift.io/v1alpha2
kind: ImageSetConfiguration
storageConfig:
  registry:
    imageURL: mavazque-virt.cloud.lab.eng.bos.redhat.com:8443/ocp4/openshift4 # Registry where we will mirror the images
    skipTLS: true
mirror:
  ocp: # OCP Releases we want to mirror
    channels:
      - name: stable-4.9
        minVersion: 4.9.21
        maxVersion: 4.9.21
  operators: # Operators we want to mirror
    - catalog: registry.redhat.io/redhat/redhat-operator-index:v4.9 # References entire catalog
      headsOnly: false # References latest version of each operator in catalog (true is the default value and can be omitted)
      packages:
        - name: local-storage-operator
          channels:
            - name: 'stable'
        - name: advanced-cluster-management
          channels:
            - name: "release-2.4"
~~~

### **Running the mirroring**

Now that we have the config file ready we just need to run the mirror command. This command expects the user to be logged in the different registries that will be used. If you have a pull secret you can get it copied to `${XDG_RUNTIME_DIR}/containers/auth.json`, and it will be consumed by the tool.

~~~sh
/usr/bin/cp -f pull_secret.json ${XDG_RUNTIME_DIR}/containers/auth.json

oc-mirror --config imageset-config.yaml docker://mavazque-virt.cloud.lab.eng.bos.redhat.com:8443 --dest-skip-tls
~~~

After a while we will have the content mirrored on our Quay registry!